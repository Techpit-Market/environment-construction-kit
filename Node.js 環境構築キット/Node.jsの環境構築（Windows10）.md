> ここではWindows10におけるNode.jsの環境構築方法を記載しています。
>
> WSL2とUbuntu20.04導入済みを前提としています。
>
> 「asdf」というバージョン管理ツールを使用してインストールします。
>
> ここから教材

# Node.jsの環境構築（Windows10）
Webアプリケーションの開発を始めるにあたって、Node.jsをインストールしていきます。

もし既にお手元のPCにNode.jsの環境があれば、このパートは読み飛ばしても大丈夫です。

::: warn
今回のパートで環境構築する対応のOSはWindows10になります。
:::

すでにNode.jsがインストールされているかどうかはコマンドで確認できます。

Ubuntuの端末(ターミナル)を開いて以下のコマンドを入力し、エンターキーを押して実行してみましょう。

```console
node -v
```

<img src="https://user-images.githubusercontent.com/25563739/131724914-01eb9466-a79b-4eed-bb28-d726cff8e581.png" width="700">


以下のようにインストールされているNode.jsのバージョンが表示されれば、すでにインストール済みです。

```
v14.17.5
```

Node.jsの最新バージョンを確認するには以下の公式ページを参照してください。

- [Node.js](https://nodejs.org/ja/)

最新バージョンは以下の画像の赤枠で囲った箇所に記載されています(以下の画像は2021/10/19現在のもの)。

<img width="1040" src="https://user-images.githubusercontent.com/25563739/137866265-ecb99c9d-95d1-4f7c-beba-cf9bda1a9cad.png">

もし`v12.○.○`や`v13.○.○`など、古いバージョンを使用している場合は、必ず最新バージョンにアップデートしてください。

`v14.○.○`を使用している方も、最新バージョンでない場合はアップデートすることをおすすめします。

## バージョン管理ツール 「asdf」 のインストール
バージョン管理ツールは、言語のバージョンを簡単に切り替えることができるツールです。

使っている環境全体のバージョンだけでなく、プロジェクトごとにバージョンを設定することもできます。

Node.jsでは「nvm」、Rubyでは「rbenv」など、それぞれの言語のバージョン管理ツールが用意されていますが、複数の管理ツールがあると、そのツール自体の管理にも手間がかかります。

そこで今回は、様々なプログラミング言語をまとめて管理できる**asdf**というツールをインストールします。

asdfはプログラミング言語だけでなく、MySQLやBundlerなどのツールのバージョンも管理することができます。

## curlとgitのインストール
asdfのインストールに必要なcurlとgitというパッケージをインストールします。

最初にすでにインストールされているか確認しましょう。

gitがインストール済みか確かめるため、以下のコマンドを実行してください。

```console
git --version
```

以下のようにバージョンの情報が表示されればインストール済みです。

```
git version 2.25.1
```

続いて、curlがインストール済みか確かめるため、以下のコマンドを実行してください。

```console
curl --version
```

以下のようにバージョンの情報が表示されればインストール済みです。

```
curl 7.68.0 (x86_64-pc-linux-gnu) libcurl/7.68.0 OpenSSL/1.1.1f zlib/1.2.11 brotli/1.0.7 
・
・
・
```

もしどちらか1つでもインストールされていない場合は、以下のコマンドを実行してください。

```console
sudo apt install -y curl git
```

コマンドを実行すると、以下のようにパスワードを聞かれる場合があります。

```
[sudo] password for ユーザ名:
```

上記のメッセージが表示されたら、Ubuntuのユーザアカウントの作成時に登録したパスワードを入力してください。

パスワードを入力しエンターキーを押すと、インストールがはじまります。

以降も上記のようなメッセージが表示された場合は、同じようにパスワードを入力してください。

インストールがはじまると、数十行のメッセージが表示されます。

インストールが終わったら、再度以下のコマンドを順番に実行し、インストールされたか確認してください。

```console
git --version
curl --version
```

:::info
### aptコマンドの説明
`apt`コマンドはLinuxにパッケージをインストール、アンインストール、アップデートなどを行なうためのコマンドです。

`apt install {パッケージ名1} {パッケージ名2} ・・・`とすることで、複数のパッケージを同時にインストールすることができます。

インストール時には通常、指定したパッケージのインストールを続行するかどうかを確認するメッセージが表示されますが、`-y`オプションを付加することで、確認をスキップしてインストールすることができます。

パッケージのインストールはすべての権限を持つユーザーアカウント(スーパーユーザ)でしか実施することができません。

`sudo`コマンドを実行したいコマンドの頭に付加することで、スーパーユーザとして実行することができます。:::

## asdfをGithubからクローン
次にasdfをGithubからクローン(コピー)します。

以下のコマンドを実行してください。

```console
sudo git clone https://github.com/asdf-vm/asdf.git /usr/local/asdf --branch v0.8.1
```

以下のようなメッセージが表示されたらクローンは完了です。

```
Cloning into '/usr/local/asdf'...
remote: Enumerating objects: 6531, done.
remote: Counting objects: 100% (698/698), done.
remote: Compressing objects: 100% (459/459), done.
remote: Total 6531 (delta 336), reused 478 (delta 215), pack-reused 5833
Receiving objects: 100% (6531/6531), 1.52 MiB | 1.46 MiB/s, done.
Resolving deltas: 100% (3683/3683), done.
Note: switching to 'a1ef92adb0cfd1e05b89feed93dd8b24c991134f'.
・
・
・
```

:::info
### `git clone`コマンドの説明
`git clone`コマンドはインターネット上などに存在するプロジェクト(リモートリポジトリ)をお使いのPCへコピーするコマンドです。

`git clone {プロジェクトのURL} {コピーする場所} --branch {ブランチ名}`とすることで、クローンすることができます。

gitについて詳しく学びたい方は、Techpitの以下の教材をおすすめします。

- [もう怖くないGit！チーム開発で必要なGitを完全マスター | Techpit](https://www.techpit.jp/courses/33):::

## asdfの操作権限の設定
asdfをスーパーユーザでなくても実行できるように設定をします。

すべてのファイルやディレクトリは所有者や権限を設定することができ、誰でも勝手に内容を変更したり、削除することができないようになっています。

しかし、ユーザーひとりひとりのファイルごとの権限を設定するのは非常に手間なため、グループというユーザーの「まとめ」を作って、一括で管理できるようになっています。

ここではasdfを利用できるグループを作成し、asdfの操作権限を付与します。

その後、グループに実行ユーザを追加します。

### グループの作成

まずはasdfを実行できるユーザのグループを作成します。

以下のコマンドを実行してください。

```console
sudo groupadd asdf
```

コマンドを実行しても特にメッセージは表示されません。

「asdf」という名前のグループを作成しました。

### asdfの管理グループを設定
次にasdfが保存されているディレクトリ(`/usr/local/asdf`)を管理するグループとして、先ほど作成したasdfグループを設定します。

以下のコマンドを実行してください。

```console
sudo chgrp -R asdf /usr/local/asdf
```

コマンドを実行しても特にメッセージは表示されません。

### asdfのアクセス権を設定
次にディレクトリのアクセス権を変更します。

ファイルやディレクトリはユーザーやグループごとに読み込み権限、書き込み権限、実行権限などの権限を個別に付与できます。

今回はasdfグループに`/usr/local/asdf`ディレクトリのすべての権限を付与します。

以下のコマンドを実行してください。

```console
sudo chmod -R g+rwXs /usr/local/asdf
```

コマンドを実行しても特にメッセージは表示されません。

### 作成したグループにユーザを追加
次にasdfグループにお使いのユーザアカウントを追加します。

以下のコマンドを実行してください。

```console
sudo gpasswd -a {ユーザ名} asdf
```

`[ユーザ名]`の箇所にはお使いのユーザアカウント名に置き換えて実行してください。

お使いのユーザアカウント名は以下のコマンドで確認できます。

```console
whoami
```

### 設定の反映
次にここまで行なった設定を反映します。

以下のコマンドを実行してください。

```console
exec bash -l
```

コマンドを実行しても特にメッセージは表示されません。

権限が正しく設定されているか確認してましょう。

以下のコマンドを実行してください。

```console
ls -l /usr/local
```

`ls -l`コマンドはファイルやディレクトリの詳細を、以下のような形式で一覧表示します。

```
ファイルの種類とアクセス権 ハードリンク数 所有者　グループ ファイルサイズ タイムスタンプ（最終更新日） ファイル名
```

以下のように、`asdf`ディレクトリのアクセス権が`drwxrwsr-x `と設定されていて、グループに`asdf`が設定されていれば成功です。

<img src="https://user-images.githubusercontent.com/25563739/131725254-59a04b75-edf9-41f6-bfaf-bbe86fc5a197.png" width="900">

以上で、asdfの操作権限の設定は完了です。

## asdfにPATHを通す
`asdf`コマンドを利用するために、**PATHを通す**という作業をします。

「PATHを通す」とは、コマンドの実行ファイルの場所を指定することです。

PATHを通していない場合、`asdf`を実行するには`/usr/local/asdf/bin/asdf`とコマンドを記述する必要がありますが、PATHを通すことで単に`asdf`とコマンドを記述することで実行することができるようになります。

それではPATHを通します。

最初に必要な環境変数を記述する`/etc/profile.d/asdf.sh`ファイルを作成します。

以下のコマンドを実行してください。

```console
sudo vi /etc/profile.d/asdf.sh
```

以下のような画面が表示されます。

<img src="https://user-images.githubusercontent.com/25563739/131725110-a4c52a64-e594-4d4f-82d0-79fb87b5ede6.png" width="800">

最初にキーボードの`i`キーを押してください。

以下のようにウインドウの下部に`INSERT`と表示されれば、書き込みの準備ができています。

<img src="https://user-images.githubusercontent.com/25563739/131725088-99f07237-ea85-4221-adda-0234b7d3e11e.png" width="800">

以下のコードをコピー(Ctrl + c)し、ファイルに貼り付けて(Ctrl + v)ください。

```sh:/etc/profile.d/asdf.sh
export ASDF_DIR=/usr/local/asdf
export ASDF_DATA_DIR=$ASDF_DIR

ASDF_BIN="${ASDF_DIR}/bin"
ASDF_USER_SHIMS="${ASDF_DATA_DIR}/shims"
PATH="${ASDF_BIN}:${ASDF_USER_SHIMS}:${PATH}"

. "${ASDF_DIR}/lib/asdf.sh"
. "${ASDF_DIR}/completions/asdf.bash"
```

コードを貼り付けたらキーボードの`エスケープ(ESC)`キーを押してください。

ウインドウの下部に表示されていた`INSERT`が消えていることを確認してください。

次に`:wq`と入力し、エンターキーを押してください。

ファイルが保存されます。

最後に設定を反映します。

以下のコマンドを実行してください。

```console
source /etc/profile.d/asdf.sh
```

コマンドを実行しても特にメッセージは表示されません。

以上で`asdf`コマンドを使用するために必要なPATHが通りました。

## 動作確認
`asdf`コマンドが使用できるようになったか動作確認しましょう。

以下のコマンドを実行してください。

```console
asdf --version
```

以下のように、バージョン情報が表示されれば完了です。

```
v0.8.1-a1ef92a
```

## 必要なパッケージのインストール
Node.jsのインストールに必要なパッケージを`apt`を利用してインストールします。

以下のコマンドを実行してください。

```console
sudo apt install -y dirmngr gpg gawk
```

コマンドを実行すると数十行のメッセージが表示されます。

以下のコマンドを実行して、dirmngrがインストールできたら確認してください。

```console
dirmngr --version
```

以下のようなメッセージが表示されればインストール成功です。

```
dirmngr (GnuPG) 2.2.19
・
・
・
```

次に以下のコマンドを実行して、gpgがインストールできたら確認してください。

```console
gpg --version
```

以下のようなメッセージが表示されればインストール成功です。

```
gpg (GnuPG) 2.2.19
・
・
・
```

次にgawkの確認をします。

以下のコマンドを実行してください。

```console
gawk --version
```

以下のようなメッセージが表示されればインストール成功です。

```
GNU Awk 5.1.0, API: 2.0 (GNU MPFR 4.0.2, GNU MP 6.2.0)
・
・
・
```

続いて、Node.jsをインストールするのに必要なプラグインをインストールします。

以下のコマンドを実行してください。

```console
asdf plugin add nodejs https://github.com/asdf-vm/asdf-nodejs.git
```

上記のコマンドを実行して、「Permission denied ・・・」といったエラーが表示される場合は、Ubuntuの端末(ターミナル)を一度閉じ、開き直してから、もう一度コマンドを実行してください。

以下のコマンドを実行して、プラグインがインストールできたか確認しましょう。

```console
asdf plugin list
```

以下のように表示されれば成功です。

```
nodejs
```

## Node.jsのインストール
今回はLTS（Long Term Support）と呼ばれる、長期サポートが保証されている最新のバージョンをインストールします。

以下のコマンドを実行してください。

```console
asdf install nodejs lts
```

インストールが完了すると、以下のようなメッセージが表示されます。

```
・
・
・
node-v14.17.5-darwin-x64.tar.gz: OK
Linking "lts" to "14.17.5"
```

Node.jsがインストールされたか確認しましょう。

下記のコマンドを入力してください。

```console
asdf list nodejs
```

以下のように`lts`と表示されれば成功です。

```
  14.17.6
  lts
```

## バージョンを設定する
先ほどインストールしたLTSバージョンを使用する設定をします。

バージョンの設定は、OS全体(グローバル)で同じバージョンを設定する方法と、プロジェクトごと(ローカル)に異なるバージョンを設定する方法があります。

ここではグローバルに設定する方法を説明します。

以下のコマンドを実行してください。

```console
asdf global nodejs lts
```

コマンドを実行しても特にメッセージは表示されません。

バージョンが設定されたか確認しましょう。

以下のコマンドを実行してください。

```console
node -v
```

以下のようにバージョンが表示されれば成功です。

```
v14.17.6
```

以上でNode.jsの環境構築は完了です。

## バージョンの変更方法
LTSとなるバージョンは更新され続けるため、最新のバージョンを使用したい場合は、そのバージョンをインストールする必要があります。

また、プロジェクトによって使用するバージョンが異なることもよくあるため、ここではNode.jsのバージョンを変更する方法を説明します。

Node.jsの最新の情報は以下の公式ページを参照してください。

- [Node.js](https://nodejs.org/ja/)

### asdfのプラグインをアップデートする
Node.jsをインストールするのに必要なプラグインのアップデートをします。

以下のコマンドを実行してください。

```console
asdf plugin update nodejs
```

プラグインがアップデートされ、最新のNode.jsが利用できるようになります。

### 指定のバージョンをインストールする
まずはインストールしたいバージョンが利用できるか確認します。

以下のコマンドを実行してください。

```console
asdf list all nodejs
```

以下のようにインストール可能なバージョンが表示されます。

```console
・
・
・
16.6.1
16.6.2
16.7.0
```

バージョンを確認したら、以下のコマンドを実行してください。

```console
asdf install nodejs {バージョン}
```

`{バージョン}`の箇所には`16.7.0`のように、インストールしたいバージョンを入力してください。

`{バージョン}`の箇所に`latest`を指定すると、最新のバージョンがインストールされます。

`lts`を指定すると、現時点でのLTSのバージョンがインストールされます。

コマンドを実行すると以下のようなメッセージが表示されます。

```
・
・
・
node-v16.7.0-darwin-x64.tar.gz: OK
```

インストールできているか確認しましょう。

以下のコマンドを実行してください。

```console
asdf list nodejs
```

以下のようにインストールしたバージョンが表示されていれば成功です。

```
  14.17.5
  16.7.0
  lts
```

### バージョンを設定する
インストールが完了したら、バージョンを使用する設定をしましょう。

グローバルに設定する場合は、以下のコマンドを実行してください。

```console
asdf global nodejs <バージョン>
```

ローカルに設定する場合は、設定したいプロジェクトのルートディレクトリに移動し、以下のコマンドを実行してください。

```console
asdf local nodejs <バージョン>
```

コマンドを実行しても特にメッセージは表示されません。

バージョンが設定されたか確認しましょう。

以下のコマンドを実行してください。

```console
node -v
```

以下のように設定したバージョンが表示されれば成功です。

```
v16.7.0
```

以上でNode.jsのバージョン変更は完了です。

お疲れ様でした。
